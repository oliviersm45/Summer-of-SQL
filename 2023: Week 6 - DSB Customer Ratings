WITH PRE_PIVOT As (select Customer_ID, 
SPLIT_PART(PIVOT_COLUMNS,'___',1) as Platform,
SPLIT_PART(PIVOT_COLUMNS,'___',2) as Element,value from
(select *
from pd2023_wk06_dsb_customer_survey)
as src  UNPIVOT(Value For PIVOT_Columns IN (
 MOBILE_APP___EASE_OF_USE, MOBILE_APP___EASE_OF_ACCESS, MOBILE_APP___NAVIGATION, MOBILE_APP___LIKELIHOOD_TO_RECOMMEND, MOBILE_APP___OVERALL_RATING, ONLINE_INTERFACE___EASE_OF_USE, ONLINE_INTERFACE___EASE_OF_ACCESS, ONLINE_INTERFACE___NAVIGATION, ONLINE_INTERFACE___LIKELIHOOD_TO_RECOMMEND, ONLINE_INTERFACE___OVERALL_RATING)))

 ,CTE_3 as (
 SELECT * 
 FROM PRE_PIVOT
PIVOT (SUM(VALUE)
FOR Platform IN ('MOBILE_APP','ONLINE_INTERFACE'))
WHERE ELEMENT != 'OVERALL_RATING')

, CTE_4 as(
SELECT customer_Id, AVG("'MOBILE_APP'")as AVG_MOBILE_VALUE,AVG("'ONLINE_INTERFACE'")as AVG_ONLINE_INTERFACE_VALUE,
AVG("'MOBILE_APP'")-AVG("'ONLINE_INTERFACE'") as diff,
CASE
WHEN AVG("'MOBILE_APP'")-AVG("'ONLINE_INTERFACE'") >=2 then 'MOBILE SUPERFAN'
WHEN AVG("'MOBILE_APP'")-AVG("'ONLINE_INTERFACE'") >=1 then 'MOBLIE APP FAN'
WHEN AVG("'MOBILE_APP'")-AVG("'ONLINE_INTERFACE'") <=-2 then 'ONLINE SUPERFAN SUPERFAN'
WHEN AVG("'MOBILE_APP'")-AVG("'ONLINE_INTERFACE'") <=-1 then 'ONLINE FAN'
else 'NEUTRAL'
end as category
FROM
CTE_3
GROUP BY Customer_ID)
,  CTE_5 as(
SELECT category,COUNT(CUstomer_id)/
(SELECT COUNT( customer_id) from CTE_4) as total_customers
FROM CTE_4
group by category)

SELECT Category,ROUND (Total_Customers*100,1) as Percent_of_Total FROM CTE_5
